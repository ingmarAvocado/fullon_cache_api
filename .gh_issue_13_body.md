# Issue #13: FastAPI WebSocket Test Infrastructure - Real Redis Testing with Factories

## üéØ CRITICAL: NO MOCKS ‚Äî Real Redis Testing Only

This issue implements a comprehensive test infrastructure using REAL REDIS INSTANCES with FACTORY PATTERNS following the proven approach from `fullon_cache_tests/` directory. NO MOCKING of Redis or cache operations.

Update: Coverage target set to ‚â•90% for the new testing stack (real-Redis + factories + WebSocket flows). Higher is welcome, but 90%+ is the success bar.

## Architecture: Real Redis + Factories + FastAPI WebSocket Testing

### üî¥ Testing Philosophy: Real Infrastructure Only

‚úÖ CORRECT: Real Redis testing with factories
```python
async def test_ticker_websocket_real_redis(real_redis_fixture, ticker_factory):
    """Test ticker WebSocket with real Redis data."""
    # Setup: Insert real data using factory
    ticker = ticker_factory.create(symbol="BTC/USDT", exchange="binance", price=50000.0)
    
    async with TickCache() as cache:
        await cache.set_ticker(ticker)
    
    # Test: WebSocket with real cache lookup
    async with websocket_client.websocket_connect("/ws/tickers/client1") as ws:
        request = {
            "action": "get_ticker",
            "request_id": "req1", 
            "params": {"exchange": "binance", "symbol": "BTC/USDT"}
        }
        await ws.send_json(request)
        
        response = await ws.receive_json()
        assert response["success"] is True
        assert response["result"]["price"] == 50000.0
```

‚ùå WRONG: Mocked testing (DO NOT USE)
```python
@patch('fullon_cache.TickCache')  # ‚Üê NO MOCKS ALLOWED!
async def test_ticker_mock(mock_cache):
    # This approach is forbidden
    pass
```

### Test Infrastructure Foundation

Following the proven `fullon_cache_tests/` pattern with real Redis and factories:

```python
# tests/conftest.py - Real Redis fixtures
import asyncio
import pytest
from fullon_cache import TickCache, OrdersCache, BotCache
from .factories import TickerFactory, OrderFactory, BotFactory

@pytest.fixture(scope="function")
async def real_redis_fixture():
    """Provide real Redis connection with test isolation."""
    import redis.asyncio as redis
    import uuid
    
    # Generate unique test namespace
    test_namespace = f"test_cache_api_{uuid.uuid4().hex[:8]}"
    
    # Connect to real Redis test database
    redis_client = redis.Redis(host='localhost', port=6379, db=15)
    
    try:
        await redis_client.ping()  # Verify Redis is available
        yield {'client': redis_client, 'namespace': test_namespace}
    finally:
        # Cleanup: Remove all test data
        pattern = f"{test_namespace}:*"
        keys = await redis_client.keys(pattern)
        if keys:
            await redis_client.delete(*keys)
        await redis_client.close()

@pytest.fixture
async def real_tick_cache(real_redis_fixture):
    """Real TickCache instance for testing."""
    async with TickCache() as cache:
        cache._namespace = real_redis_fixture['namespace']
        yield cache

# tests/factories/ticker.py - Factory for realistic data
from fullon_orm.models import Tick
from decimal import Decimal
import time

class TickerFactory:
    """Create realistic ticker data for Redis cache testing."""
    
    def create(self, symbol="BTC/USDT", exchange="binance", price=50000.0, **kwargs):
        """Create realistic ticker with proper spreads and data."""
        bid = price - (price * 0.0001)  # 0.01% spread
        ask = price + (price * 0.0001)
        
        return Tick(
            symbol=symbol,
            exchange=exchange,
            price=Decimal(str(price)),
            volume=Decimal(str(kwargs.get('volume', 1234.56))),
            time=kwargs.get('time', time.time()),
            bid=Decimal(str(bid)),
            ask=Decimal(str(ask)),
            last=Decimal(str(price)),
            change_24h=kwargs.get('change_24h', 2.5)
        )
    
    def create_batch(self, count=10, exchange="binance", **kwargs):
        """Create multiple realistic tickers."""
        symbols = ["BTC/USDT", "ETH/USDT", "BNB/USDT", "ADA/USDT", "XRP/USDT"]
        return [self.create(symbol=symbols[i % len(symbols)], **kwargs) for i in range(count)]
```

### Real Integration Tests

```python
# tests/integration/test_ticker_websocket_real.py
class TestTickerWebSocketReal:
    """Test ticker WebSocket with real Redis backend."""
    
    @pytest.mark.asyncio
    async def test_get_ticker_real_redis(self, real_tick_cache, ticker_factory):
        """Test WebSocket ticker retrieval with real Redis data."""
        # Setup: Create and store real ticker
        ticker = ticker_factory.create(symbol="BTC/USDT", exchange="binance", price=50000.0)
        await real_tick_cache.set_ticker(ticker)
        
        # Test: Real WebSocket request
        async with websocket_client.websocket_connect("/ws/tickers/test") as ws:
            request = {
                "action": "get_ticker",
                "request_id": "req1",
                "params": {"exchange": "binance", "symbol": "BTC/USDT"}
            }
            
            response = await websocket_client.send_and_receive(ws, request)
            
            # Verify real data was retrieved from Redis
            assert response["success"] is True
            assert response["result"]["price"] == 50000.0
    
    @pytest.mark.asyncio 
    async def test_stream_tickers_real_redis(self, real_tick_cache, ticker_factory):
        """Test real-time ticker streaming with real Redis updates."""
        # Setup: Create real ticker data
        tickers = ticker_factory.create_batch(count=3, exchange="binance")
        for ticker in tickers:
            await real_tick_cache.set_ticker(ticker)
        
        # Test: Start real streaming
        async with websocket_client.websocket_connect("/ws/tickers/stream") as ws:
            stream_request = {
                "action": "stream_tickers", 
                "request_id": "stream1",
                "params": {
                    "exchange": "binance",
                    "symbols": ["BTC/USDT", "ETH/USDT", "BNB/USDT"]
                }
            }
            
            # Start streaming
            confirmation = await websocket_client.send_and_receive(ws, stream_request)
            assert confirmation["success"] is True
            
            # Update real Redis data to trigger stream updates
            for ticker in tickers:
                ticker.price += 100
                await real_tick_cache.set_ticker(ticker)
            
            # Receive real stream updates
            updates = []
            for _ in range(3):
                update_text = await asyncio.wait_for(ws.recv(), timeout=5.0)
                update = json.loads(update_text)
                if update.get('action') == 'ticker_update':
                    updates.append(update)
            
            assert len(updates) == 3
            # Verify real data in stream updates
            for update in updates:
                assert update['result']['exchange'] == 'binance'
                assert 'price' in update['result']
```

## Implementation Requirements

1) MANDATORY: Real Redis Only (NO MOCKS)
- All tests use real Redis instances (localhost:6379, db=15)
- Factory patterns for realistic test data generation
- Test isolation with unique namespaces per test
- Automatic cleanup after each test completion

2) Factory System (Following fullon_cache_tests/)
- `TickerFactory`, `OrderFactory`, `BotFactory`, etc.
- Realistic data with proper relationships and spreads  
- Batch creation for performance testing
- Time-based data generation for streaming tests

3) FastAPI WebSocket Testing
- Real WebSocket connections to FastAPI endpoints
- Test message routing with actual Redis operations
- Streaming validation with real-time Redis updates
- Connection lifecycle testing with real cache backends

4) Test Organization
```
tests/
‚îú‚îÄ‚îÄ conftest.py                    # Real Redis fixtures
‚îú‚îÄ‚îÄ factories/                     # Data factories (NO MOCKS)
‚îÇ   ‚îú‚îÄ‚îÄ ticker.py, order.py, etc. 
‚îú‚îÄ‚îÄ integration/                   # End-to-end with real Redis
‚îú‚îÄ‚îÄ unit/                          # Component tests with real Redis
‚îî‚îÄ‚îÄ websocket_client.py            # WebSocket test utilities
```

## Files to Create/Modify

1. `tests/conftest.py` - Real Redis fixtures and factory setup
2. `tests/factories/*.py` - All factory classes for test data
3. `tests/integration/test_*_websocket_real.py` - Real Redis integration tests
4. `tests/websocket_client.py` - FastAPI WebSocket test client
5. `tests/performance/test_*_performance_real.py` - Performance tests with real Redis

## Success Criteria

- [ ] Complete test infrastructure using real Redis (NO MOCKS ANYWHERE)
- [ ] Factory system following fullon_cache_tests patterns exactly
- [ ] ‚â•90% coverage for the new testing stack using real cache operations only
- [ ] FastAPI WebSocket tests with real Redis backends
- [ ] Performance testing with actual Redis infrastructure
- [ ] Test isolation and cleanup for parallel execution

Architecture: Real Redis + Factory Patterns + FastAPI WebSocket Testing (ZERO MOCKS)
